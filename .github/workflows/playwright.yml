name: Playwright Tests
on:
  push:
    branches: [ main, master ]
  pull_request:
    branches: [ main, master ]

permissions:
  actions: write
  contents: read

jobs:
  wake-up:
    runs-on: ubuntu-latest
    steps:
    - uses: actions/create-github-app-token@v2
      id : create_token
      with:
        app-id: ${{ secrets.GH_APP_ID }}
        private-key: ${{ secrets.GH_APP_PRIVATE_KEY }}
        owner: ${{ github.repository_owner }}
        repositories: sample-self-hosted-runner
    
    - name: Generate JIT
      id: generate_jit
      run: |
        JIT_CONFIG=$(gh api \
          --method POST \
          -H "Accept: application/vnd.github+json" \
          -H "X-GitHub-Api-Version: 2022-11-28" \
          /repos/${{ github.repository }}/sample-self-hosted-runner/actions/runners/generate-jitconfig \
          --input - <<< '{
          "name": "New runner",
          "runner_group_id": 1,
          "labels": [
            "self-hosted",
            "arm64",
            "linux",
            "no-gpu"
          ],
          "work_folder": "_work"
        }' \
        | jq -r '.encoded_jit_config')
        echo "config=${JIT_CONFIG}" >> $GITHUB_OUTPUT
      env:
        GH_TOKEN: ${{ steps.create_token.outputs.token }}

    - uses: aws-actions/configure-aws-credentials@v5
      with:
        aws-access-key-id: ${{ secrets.AWS_ACCESS_KEY_ID }}
        aws-secret-access-key: ${{ secrets.AWS_SECRET_ACCESS_KEY }}
        aws-region: ap-northeast-1

    - name: Wake up self-hosted runner
      run: |
        aws ecs run-task \
          --cluster self-hosted-runner \
          --launch-type FARGATE \
          --task-definition self-hosted-runner:4 \
          --network-configuration "awsvpcConfiguration={subnets=[subnet-0d240f9fc7f422172],securityGroups=[sg-0878f4858c5b45746],assignPublicIp=ENABLED}" \
          --overrides '{
            "containerOverrides":[
              {
                "name":"playwright",
                "environment":[
                  {"name":"JIT_CONFIG","value":"${{ steps.generate_jit.outputs.config }}"}
                ]
              }
            ]
          }'
  test:
    needs: wake-up
    timeout-minutes: 60
    runs-on: self-hosted
    steps:
    - uses: actions/checkout@v4
    - uses: actions/setup-node@v4
      with:
        node-version: lts/*
    - name: Install dependencies
      run: npm ci
    - name: Run Playwright tests
      run: npx playwright test
    - uses: actions/upload-artifact@v4
      if: ${{ !cancelled() }}
      with:
        name: playwright-report
        path: playwright-report/
        retention-days: 30
